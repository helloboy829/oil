# 油品系统文件和日志位置说明

## 目录
- [系统架构概览](#系统架构概览)
- [二维码文件位置](#二维码文件位置)
- [日志文件位置](#日志文件位置)
- [数据库文件位置](#数据库文件位置)
- [配置文件位置](#配置文件位置)
- [SSL证书位置](#ssl证书位置)
- [查看和管理方法](#查看和管理方法)

---

## 系统架构概览

### 容器架构
```
宿主机 (Linux Server)
├── Nginx (端口 443) - HTTPS 服务
├── Docker 容器
│   ├── oil-frontend (端口 80) - 前端服务
│   ├── oil-backend (端口 8080) - 后端服务
│   └── oil-mysql (端口 3306) - 数据库服务
└── Docker 数据卷
    ├── mysql-data - 数据库数据
    ├── qrcode-data - 二维码文件
    └── backend-logs - 后端日志
```

### 数据持久化
所有重要数据都通过 Docker 数据卷持久化存储，即使容器删除，数据也不会丢失。

---

## 二维码文件位置

### 1. 容器内路径
```
/app/qrcodes/
```
这是后端应用生成和访问二维码的路径。

### 2. Docker 数据卷
```
卷名称: oil_qrcode-data
映射关系: qrcode-data:/app/qrcodes
```

### 3. 宿主机实际路径
```
/var/lib/docker/volumes/oil_qrcode-data/_data/
```

### 4. Web 访问路径
```
https://服务器IP/qrcodes/文件名.png
```

### 查看二维码文件

#### 方法1：查看 Docker 卷信息
```bash
# 查看卷的详细信息
docker volume inspect oil_qrcode-data

# 输出示例：
# [{
#     "Driver": "local",
#     "Mountpoint": "/var/lib/docker/volumes/oil_qrcode-data/_data",
#     ...
# }]
```

#### 方法2：通过容器查看
```bash
# 列出所有二维码文件
docker exec oil-backend ls -lh /app/qrcodes/

# 查看文件数量
docker exec oil-backend find /app/qrcodes -name "*.png" | wc -l

# 查看最新生成的文件
docker exec oil-backend ls -lt /app/qrcodes/ | head -10
```

#### 方法3：直接访问宿主机路径
```bash
# 列出文件（需要 root 权限）
ls -lh /var/lib/docker/volumes/oil_qrcode-data/_data/

# 查看文件大小统计
du -sh /var/lib/docker/volumes/oil_qrcode-data/_data/

# 查看文件数量
find /var/lib/docker/volumes/oil_qrcode-data/_data/ -name "*.png" | wc -l
```

### 备份二维码文件

```bash
# 方法1：从容器复制
docker cp oil-backend:/app/qrcodes/ ~/qrcode-backup/

# 方法2：直接复制数据卷
mkdir -p ~/qrcode-backup
cp -r /var/lib/docker/volumes/oil_qrcode-data/_data/* ~/qrcode-backup/

# 方法3：打包备份
tar -czf qrcode-backup-$(date +%Y%m%d).tar.gz \
  -C /var/lib/docker/volumes/oil_qrcode-data/_data/ .
```

---

## 日志文件位置

### 1. 后端应用日志

#### 容器内路径
```
/app/logs/
```

#### Docker 数据卷
```
卷名称: oil_backend-logs
映射关系: backend-logs:/app/logs
```

#### 宿主机实际路径
```
/var/lib/docker/volumes/oil_backend-logs/_data/
```

#### 日志文件类型
```
/app/logs/
├── oil-system.log              # 主日志文件
├── oil-system-error.log        # 错误日志
├── oil-system-2026-01-26.log   # 按日期归档的日志
└── oil-system-2026-01-26.log.gz # 压缩的历史日志
```

#### 查看后端日志
```bash
# 查看实时日志
docker exec oil-backend tail -f /app/logs/oil-system.log

# 查看最后 100 行
docker exec oil-backend tail -100 /app/logs/oil-system.log

# 查看错误日志
docker exec oil-backend cat /app/logs/oil-system-error.log

# 查看今天的日志
TODAY=$(date +%Y-%m-%d)
docker exec oil-backend cat /app/logs/oil-system-${TODAY}.log

# 搜索关键词
docker exec oil-backend grep "ERROR" /app/logs/oil-system.log

# 从宿主机查看
tail -f /var/lib/docker/volumes/oil_backend-logs/_data/oil-system.log
```

### 2. Docker 容器日志

#### 日志位置
```
/var/lib/docker/containers/<容器ID>/<容器ID>-json.log
```

#### 查看容器日志
```bash
# 查看后端容器日志
docker logs oil-backend

# 实时查看日志
docker logs -f oil-backend

# 查看最后 100 行
docker logs --tail 100 oil-backend

# 查看最近 10 分钟的日志
docker logs --since 10m oil-backend

# 查看前端容器日志
docker logs oil-frontend

# 查看 MySQL 容器日志
docker logs oil-mysql

# 查看所有容器日志
docker-compose logs

# 实时查看所有容器日志
docker-compose logs -f
```

### 3. Nginx 日志

#### 访问日志
```
/var/log/nginx/oil_access.log
```

#### 错误日志
```
/var/log/nginx/oil_error.log
```

#### 系统日志
```
/var/log/nginx/access.log
/var/log/nginx/error.log
```

#### 查看 Nginx 日志
```bash
# 查看访问日志
tail -f /var/log/nginx/oil_access.log

# 查看错误日志
tail -f /var/log/nginx/oil_error.log

# 查看最后 100 行
tail -100 /var/log/nginx/oil_access.log

# 统计访问量
cat /var/log/nginx/oil_access.log | wc -l

# 查看访问 IP 统计
awk '{print $1}' /var/log/nginx/oil_access.log | sort | uniq -c | sort -rn | head -10

# 查看访问的 URL
awk '{print $7}' /var/log/nginx/oil_access.log | sort | uniq -c | sort -rn | head -10

# 查看系统日志
journalctl -u nginx -f
```

### 4. 系统日志

#### 查看系统日志
```bash
# 查看 Docker 服务日志
journalctl -u docker -f

# 查看 Nginx 服务日志
journalctl -u nginx -f

# 查看系统消息
tail -f /var/log/messages

# 查看系统日志
tail -f /var/log/syslog
```

---

## 数据库文件位置

### Docker 数据卷
```
卷名称: oil_mysql-data
映射关系: mysql-data:/var/lib/mysql
```

### 宿主机实际路径
```
/var/lib/docker/volumes/oil_mysql-data/_data/
```

### 数据库文件结构
```
/var/lib/docker/volumes/oil_mysql-data/_data/
├── oil_system/          # 数据库目录
│   ├── product.ibd      # 产品表数据
│   ├── user.ibd         # 用户表数据
│   └── ...
├── mysql/               # 系统数据库
├── performance_schema/  # 性能监控
└── sys/                 # 系统信息
```

### 查看数据库文件
```bash
# 查看数据库文件大小
du -sh /var/lib/docker/volumes/oil_mysql-data/_data/

# 查看各数据库大小
du -sh /var/lib/docker/volumes/oil_mysql-data/_data/*/

# 列出数据库文件
ls -lh /var/lib/docker/volumes/oil_mysql-data/_data/oil_system/
```

### 备份数据库
```bash
# 方法1：使用 mysqldump（推荐）
docker exec oil-mysql mysqldump -uroot -p123456 oil_system > oil_system_backup.sql

# 方法2：备份整个数据卷
tar -czf mysql-backup-$(date +%Y%m%d).tar.gz \
  -C /var/lib/docker/volumes/oil_mysql-data/_data/ .
```

---

## 配置文件位置

### 1. 后端配置文件

#### 项目中的配置
```
/oil/backend/src/main/resources/application.yml
```

#### 容器内配置（运行时）
```
/app/application.yml
```

#### 查看配置
```bash
# 从项目查看
cat /oil/backend/src/main/resources/application.yml

# 从容器查看
docker exec oil-backend cat /app/application.yml
```

### 2. 前端配置文件

#### 项目中的配置
```
/oil/frontend/src/config/
/oil/frontend/.env
```

#### 容器内配置
```
/usr/share/nginx/html/
```

### 3. Docker 配置文件

#### Docker Compose 配置
```
/oil/docker-compose.yml
```

#### 查看配置
```bash
cat /oil/docker-compose.yml
```

### 4. Nginx 配置文件

#### 主配置文件
```
/etc/nginx/nginx.conf
```

#### 站点配置文件
```
/etc/nginx/conf.d/oil.conf
```

#### 配置模板（项目中）
```
/oil/deploy/nginx-selfsigned.conf  # 自签名证书配置
/oil/deploy/nginx-https.conf       # 正式证书配置
```

#### 查看配置
```bash
# 查看主配置
cat /etc/nginx/nginx.conf

# 查看站点配置
cat /etc/nginx/conf.d/oil.conf

# 测试配置
nginx -t
```

---

## SSL证书位置

### 证书文件路径
```
/etc/nginx/ssl/oil.crt      # 证书文件
/etc/nginx/ssl/oil.key      # 私钥文件
```

### 查看证书信息
```bash
# 查看证书详情
openssl x509 -in /etc/nginx/ssl/oil.crt -text -noout

# 查看证书有效期
openssl x509 -in /etc/nginx/ssl/oil.crt -noout -dates

# 查看证书主题
openssl x509 -in /etc/nginx/ssl/oil.crt -noout -subject
```

### 重新生成证书
```bash
# 生成新的自签名证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/oil.key \
  -out /etc/nginx/ssl/oil.crt \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Oil/CN=localhost"

# 重启 Nginx 使证书生效
systemctl restart nginx
```

---

## 查看和管理方法

### 使用日志管理工具

系统提供了专门的日志管理脚本：

```bash
# 运行日志管理工具
bash /oil/deploy/logs-manager.sh
```

#### 功能菜单
```
1. 查看所有容器日志
2. 查看后端应用日志
3. 查看错误日志
4. 实时监控日志
5. 清理旧日志
6. 备份日志
7. 查看日志统计
8. 搜索日志内容
```

### 日志备份位置
```
/oil-logs-backup/
```

### 自动清理日志

系统提供了自动清理脚本：

```bash
# 手动运行清理脚本
bash /oil/deploy/auto-cleanup-logs.sh

# 设置定时任务（每天凌晨2点执行）
crontab -e
# 添加以下行：
0 2 * * * /bin/bash /oil/deploy/auto-cleanup-logs.sh
```

---

## 磁盘空间管理

### 查看磁盘使用情况

```bash
# 查看整体磁盘使用
df -h

# 查看 Docker 占用空间
docker system df

# 查看各数据卷大小
docker volume ls
du -sh /var/lib/docker/volumes/oil_*

# 查看日志文件大小
du -sh /var/log/nginx/
du -sh /var/lib/docker/volumes/oil_backend-logs/_data/
```

### 清理磁盘空间

```bash
# 清理 Docker 未使用的资源
docker system prune -a

# 清理旧的日志文件
find /var/log/nginx/ -name "*.log.*" -mtime +30 -delete

# 清理后端旧日志
docker exec oil-backend find /app/logs -name "*.log.gz" -mtime +30 -delete

# 清理 Docker 日志
truncate -s 0 /var/lib/docker/containers/*/*-json.log
```

---

**文档版本**：1.0
**最后更新**：2026-01-26
**维护人员**：Claude Code Assistant
