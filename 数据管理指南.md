# æ²¹å“é”€å”®ç³»ç»Ÿ - æ•°æ®ç®¡ç†æŒ‡å—

## ğŸ“¦ æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 1. è‡ªåŠ¨å¤‡ä»½é…ç½® âœ…

**å·²é…ç½®å®Œæˆï¼š**
- â° **å¤‡ä»½æ—¶é—´ï¼š** æ¯å¤©å‡Œæ™¨ 2:00 è‡ªåŠ¨æ‰§è¡Œ
- ğŸ“ **å¤‡ä»½ä½ç½®ï¼š** `/oil/data/backups/`
- ğŸ”„ **ä¿ç•™æ—¶é—´ï¼š** 7å¤©ï¼ˆè‡ªåŠ¨åˆ é™¤7å¤©å‰çš„æ—§å¤‡ä»½ï¼‰
- ğŸ“ **æ—¥å¿—æ–‡ä»¶ï¼š** `/var/log/oil-backup.log`

**å¤‡ä»½æ–‡ä»¶å‘½åè§„åˆ™ï¼š**
```
oil_system_20260206_215422.sql.gz
æ ¼å¼ï¼šoil_system_YYYYMMDD_HHMMSS.sql.gz
```

---

### 2. æ‰‹åŠ¨å¤‡ä»½

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¤‡ä»½è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# SSHç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ
cd /oil
bash deploy/backup.sh
```

#### æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨Dockerå‘½ä»¤
```bash
# å¤‡ä»½åˆ°æ–‡ä»¶
docker exec oil-mysql mysqldump -uroot -p123456 oil_system > backup.sql

# å‹ç¼©å¤‡ä»½
gzip backup.sql
```

---

### 3. æ•°æ®æ¢å¤

#### æ¢å¤æœ€æ–°å¤‡ä»½
```bash
cd /oil
bash deploy/restore.sh
```

#### æ¢å¤æŒ‡å®šå¤‡ä»½æ–‡ä»¶
```bash
# æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½
ls -lh /oil/data/backups/

# è§£å‹å¤‡ä»½æ–‡ä»¶
gunzip /oil/data/backups/oil_system_20260206_215422.sql.gz

# æ¢å¤åˆ°æ•°æ®åº“
docker exec -i oil-mysql mysql -uroot -p123456 oil_system < /oil/data/backups/oil_system_20260206_215422.sql
```

---

### 4. æŸ¥çœ‹å¤‡ä»½çŠ¶æ€

#### æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
```bash
ssh root@120.79.211.158 "ls -lh /oil/data/backups/"
```

#### æŸ¥çœ‹å¤‡ä»½æ—¥å¿—
```bash
ssh root@120.79.211.158 "tail -50 /var/log/oil-backup.log"
```

#### æ£€æŸ¥å®šæ—¶ä»»åŠ¡
```bash
ssh root@120.79.211.158 "crontab -l | grep oil"
```

---

## ğŸ’¾ æ•°æ®å®‰å…¨å»ºè®®

### çº§åˆ«1ï¼šæœ¬åœ°å¤‡ä»½ï¼ˆå·²å®æ–½ï¼‰âœ…
- æœåŠ¡å™¨ä¸Šè‡ªåŠ¨å®šæ—¶å¤‡ä»½
- ä¿ç•™7å¤©å†å²å¤‡ä»½
- å ç”¨ç©ºé—´å°ï¼ˆå‹ç¼©åçº¦3KB/æ¬¡ï¼‰

### çº§åˆ«2ï¼šå¼‚åœ°å¤‡ä»½ï¼ˆå»ºè®®å®æ–½ï¼‰â­
å®šæœŸä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°ç”µè„‘ï¼š

```bash
# ä¸‹è½½æœ€æ–°å¤‡ä»½åˆ°æœ¬åœ°
scp root@120.79.211.158:/oil/data/backups/oil_system_*.sql.gz ./æœ¬åœ°å¤‡ä»½ç›®å½•/
```

**æ¨èé¢‘ç‡ï¼š** æ¯å‘¨ä¸€æ¬¡æˆ–æ¯æœˆä¸€æ¬¡

### çº§åˆ«3ï¼šå¤šé‡å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
- é…ç½®OSSå¯¹è±¡å­˜å‚¨ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘ï¼‰
- ä½¿ç”¨äº‘ç›˜åŒæ­¥ï¼ˆç™¾åº¦ç½‘ç›˜/åšæœäº‘ï¼‰
- Gitå¤‡ä»½ï¼ˆå°†SQLæ–‡ä»¶æäº¤åˆ°ç§æœ‰ä»“åº“ï¼‰

---

## ğŸ”§ å¸¸ç”¨æ•°æ®æ“ä½œ

### å¯¼å‡ºç‰¹å®šè¡¨æ•°æ®
```bash
# åªå¯¼å‡ºå®¢æˆ·è¡¨
docker exec oil-mysql mysqldump -uroot -p123456 oil_system customer > customer.sql

# åªå¯¼å‡ºè®¢å•ç›¸å…³è¡¨
docker exec oil-mysql mysqldump -uroot -p123456 oil_system orders order_item > orders_backup.sql
```

### å¯¼å…¥æ•°æ®
```bash
# å¯¼å…¥SQLæ–‡ä»¶
docker exec -i oil-mysql mysql -uroot -p123456 oil_system < data.sql
```

### æ¸…ç©ºæµ‹è¯•æ•°æ®
```bash
# æ¸…ç©ºè®¢å•æ•°æ®ï¼ˆä¿ç•™å•†å“å’Œå®¢æˆ·ï¼‰
docker exec -i oil-mysql mysql -uroot -p123456 -e "
USE oil_system;
DELETE FROM order_item;
DELETE FROM orders;
"
```

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### æ£€æŸ¥æ•°æ®åº“å¤§å°
```bash
docker exec oil-mysql mysql -uroot -p123456 -e "
SELECT
    table_schema AS 'æ•°æ®åº“',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'å¤§å°(MB)'
FROM information_schema.tables
WHERE table_schema = 'oil_system'
GROUP BY table_schema;
"
```

### æ£€æŸ¥å„è¡¨æ•°æ®é‡
```bash
docker exec oil-mysql mysql -uroot -p123456 -e "
USE oil_system;
SELECT
    table_name AS 'è¡¨å',
    table_rows AS 'è®°å½•æ•°'
FROM information_schema.tables
WHERE table_schema = 'oil_system'
ORDER BY table_rows DESC;
"
```

### ä¼˜åŒ–æ•°æ®åº“
```bash
# ä¼˜åŒ–æ‰€æœ‰è¡¨
docker exec oil-mysql mysql -uroot -p123456 -e "
USE oil_system;
OPTIMIZE TABLE product, customer, orders, order_item;
"
```

---

## ğŸš¨ åº”æ€¥æ¢å¤æµç¨‹

### åœºæ™¯1ï¼šæ•°æ®è¯¯åˆ é™¤
1. ç«‹å³åœæ­¢åº”ç”¨å†™å…¥
2. æŸ¥æ‰¾æœ€è¿‘çš„å¤‡ä»½æ–‡ä»¶
3. ä½¿ç”¨restore.shæ¢å¤
4. éªŒè¯æ•°æ®å®Œæ•´æ€§
5. é‡å¯åº”ç”¨

### åœºæ™¯2ï¼šæ•°æ®åº“æŸå
1. åœæ­¢æ‰€æœ‰å®¹å™¨ï¼š`docker-compose down`
2. å¤‡ä»½æŸåçš„æ•°æ®ç›®å½•ï¼š`mv data/mysql data/mysql.broken`
3. åˆ›å»ºæ–°ç›®å½•ï¼š`mkdir -p data/mysql && chown -R 999:999 data/mysql`
4. å¯åŠ¨MySQLï¼š`docker-compose up -d mysql`
5. ç­‰å¾…åˆå§‹åŒ–å®Œæˆï¼ˆçº¦30ç§’ï¼‰
6. æ¢å¤æœ€æ–°å¤‡ä»½ï¼š`bash deploy/restore.sh`
7. å¯åŠ¨å…¶ä»–æœåŠ¡ï¼š`docker-compose up -d`

### åœºæ™¯3ï¼šæœåŠ¡å™¨æ•…éšœ
1. å‡†å¤‡æ–°æœåŠ¡å™¨
2. å®‰è£…Dockerå’ŒDocker Compose
3. å…‹éš†é¡¹ç›®ä»£ç ï¼š`git clone https://github.com/helloboy829/oil.git`
4. ä¸Šä¼ å¤‡ä»½æ–‡ä»¶åˆ° `data/backups/`
5. å¯åŠ¨æœåŠ¡ï¼š`docker-compose up -d`
6. æ¢å¤æ•°æ®ï¼š`bash deploy/restore.sh`

---

## ğŸ“ æ•°æ®å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] æ¯å‘¨æ£€æŸ¥å¤‡ä»½æ—¥å¿—ï¼š`tail /var/log/oil-backup.log`
- [ ] æ¯æœˆä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°ç”µè„‘
- [ ] æ¯å­£åº¦æµ‹è¯•ä¸€æ¬¡æ•°æ®æ¢å¤æµç¨‹
- [ ] æ¯åŠå¹´æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´
- [ ] é‡è¦æ“ä½œå‰æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡å¤‡ä»½

---

## ğŸ”— ç›¸å…³æ–‡ä»¶ä½ç½®

| é¡¹ç›® | è·¯å¾„ |
|------|------|
| å¤‡ä»½è„šæœ¬ | `/oil/deploy/backup.sh` |
| æ¢å¤è„šæœ¬ | `/oil/deploy/restore.sh` |
| å¤‡ä»½æ–‡ä»¶ | `/oil/data/backups/*.sql.gz` |
| MySQLæ•°æ® | `/oil/data/mysql/` |
| å¤‡ä»½æ—¥å¿— | `/var/log/oil-backup.log` |

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### å¤‡ä»½å¤±è´¥
1. æ£€æŸ¥MySQLå®¹å™¨çŠ¶æ€ï¼š`docker ps | grep mysql`
2. æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š`df -h`
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`tail /var/log/oil-backup.log`

### æ¢å¤å¤±è´¥
1. ç¡®è®¤å¤‡ä»½æ–‡ä»¶å®Œæ•´ï¼š`gunzip -t backup.sql.gz`
2. æ£€æŸ¥MySQLæ˜¯å¦è¿è¡Œï¼š`docker ps | grep mysql`
3. æŸ¥çœ‹MySQLæ—¥å¿—ï¼š`docker logs oil-mysql --tail=50`

---

**æœ€åæ›´æ–°ï¼š** 2026-02-06
**ç»´æŠ¤äººå‘˜ï¼š** ç³»ç»Ÿç®¡ç†å‘˜
