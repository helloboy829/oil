# 油品系统修改记录

## 修改日期
2026-01-26

## 问题描述

用户在阿里云服务器部署油品系统后，遇到以下问题：

1. **二维码生成失败**：在商品管理页面点击"生成码"按钮时失败
2. **手机摄像头权限问题**：在手机上点击"开始扫码"时提示"无法启动摄像头，请检查权限"

## 问题分析

### 1. 二维码生成问题
- **原因**：配置文件路径已正确（`/app/qrcodes/`）
- **状态**：无需修改，配置正确

### 2. 摄像头权限问题
- **原因**：现代浏览器要求使用 HTTPS 才能访问摄像头（getUserMedia API）
- **解决方案**：部署 HTTPS 服务

### 3. 前端 API 调用问题
- **原因**：前端代码使用了相对路径
- **状态**：无需修改，已使用相对路径

## 修改内容

### 1. 部署脚本路径修正

#### 文件：`deploy/setup-https.sh`
**修改原因**：项目实际位于 `/oil` 而非 `/root/oil`

**修改内容**：
```bash
# 第 22 行：修改工作目录
cd /oil

# 第 59 行：修改配置文件复制路径
cp /oil/deploy/nginx-selfsigned.conf /etc/nginx/conf.d/oil.conf

# 第 73 行：修改工作目录
cd /oil
```

**提交信息**：修正部署脚本中的路径引用

---

#### 文件：`deploy/logs-manager.sh`
**修改原因**：备份目录路径需要与项目路径一致

**修改内容**：
```bash
# 第 17 行：修改备份目录
BACKUP_DIR="/oil-logs-backup"
```

---

#### 文件：`deploy/auto-cleanup-logs.sh`
**修改原因**：备份目录路径需要与项目路径一致

**修改内容**：
```bash
# 第 29 行：修改备份目录查找路径
find /oil-logs-backup -name "*.tar.gz" -mtime +60 -delete 2>/dev/null || true
```

**Git 提交**：
- Commit ID: `1d346cc`
- 提交信息：修正部署脚本路径

---

### 2. Nginx 配置修改

#### 文件：`/etc/nginx/nginx.conf`（服务器端）
**修改原因**：Nginx 主配置文件中的默认 server 块监听 80 端口，与 Docker 前端容器冲突

**修改内容**：
```nginx
# 注释掉第 39-53 行的默认 server 块
#    server {
#        listen       80;
#        listen       [::]:80;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#        location = /404.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#        location = /50x.html {
#        }
#    }
```

**修改位置**：服务器 `/etc/nginx/nginx.conf`

---

#### 文件：`/etc/nginx/conf.d/oil.conf`（服务器端）
**修改原因**：HTTP 重定向 server 块也监听 80 端口，造成冲突

**修改内容**：
```nginx
# 注释掉第 5-12 行的 HTTP 重定向 server 块
# # HTTP 服务器 - 自动跳转到 HTTPS
# server {
#     listen 80;
#     server_name _;
#
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }
```

**修改位置**：服务器 `/etc/nginx/conf.d/oil.conf`

---

### 3. Git 配置

#### 服务器端 Git 用户配置
**修改原因**：服务器上未配置 Git 用户信息，无法进行 Git 操作

**执行命令**：
```bash
git config --global user.email "helloboy829@example.com"
git config --global user.name "helloboy829"
```

---

## 部署架构变更

### 原架构
- 前端：Docker 容器（端口 80）
- 后端：Docker 容器（端口 8080）
- 数据库：Docker 容器（端口 3306，未映射）
- 访问方式：HTTP

### 新架构
- **Nginx**：宿主机（端口 443 HTTPS）
- **前端**：Docker 容器（端口 80）
- **后端**：Docker 容器（端口 8080）
- **数据库**：Docker 容器（端口 3306，未映射）
- **访问方式**：HTTPS（自签名证书）

### 请求流程
```
用户浏览器 (HTTPS)
    ↓
Nginx (443端口，SSL终止)
    ↓
前端容器 (80端口) ← 静态文件
    ↓
后端容器 (8080端口) ← API请求
    ↓
MySQL容器 (3306端口)
```

---

## 配置文件说明

### 1. application.yml
**位置**：`backend/src/main/resources/application.yml`

**关键配置**：
```yaml
# 二维码配置
qrcode:
  width: 300
  height: 300
  save-path: /app/qrcodes/  # 容器内路径
```

**状态**：✅ 配置正确，无需修改

---

### 2. docker-compose.yml
**位置**：`docker-compose.yml`

**关键配置**：
```yaml
backend:
  volumes:
    - qrcode-data:/app/qrcodes  # 二维码持久化存储
    - backend-logs:/app/logs     # 日志持久化存储

frontend:
  ports:
    - "80:80"  # 映射到宿主机 80 端口
```

**状态**：✅ 配置正确，无需修改

---

### 3. Nginx 配置
**位置**：`deploy/nginx-selfsigned.conf`

**关键配置**：
```nginx
server {
    listen 443 ssl http2;

    # SSL 证书
    ssl_certificate /etc/nginx/ssl/oil.crt;
    ssl_certificate_key /etc/nginx/ssl/oil.key;

    # 前端代理
    location / {
        proxy_pass http://localhost:80;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
    }

    # 二维码图片代理
    location /qrcodes/ {
        proxy_pass http://localhost:8080/qrcodes/;
    }
}
```

**状态**：✅ 配置正确，已部署

---

## 遇到的问题及解决方案

### 问题1：Git Pull 失败
**错误信息**：
```
fatal: unable to access 'https://github.com/helloboy829/oil.git/': Encountered end of file
```

**原因**：阿里云服务器访问 GitHub 网络不稳定

**解决方案**：手动修改文件，不使用 git pull

---

### 问题2：Git 用户未配置
**错误信息**：
```
*** Please tell me who you are.
fatal: unable to auto-detect email address
```

**解决方案**：
```bash
git config --global user.email "helloboy829@example.com"
git config --global user.name "helloboy829"
```

---

### 问题3：Docker 端口 80 冲突
**错误信息**：
```
Error starting userland proxy: listen tcp4 0.0.0.0:80: bind: address already in use
```

**原因**：Nginx 已占用 80 端口

**尝试方案1**：使用 Docker 网络名称 `oil-frontend`
- **结果**：失败
- **原因**：Nginx 运行在宿主机，无法解析 Docker 容器名称

**最终方案**：保持 Docker 前端映射 80 端口，Nginx 只监听 443 端口

---

### 问题4：Nginx 启动失败（端口冲突）
**错误信息**：
```
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
```

**原因**：
1. Nginx 主配置文件 `/etc/nginx/nginx.conf` 中有默认 server 块监听 80 端口
2. Nginx 站点配置 `/etc/nginx/conf.d/oil.conf` 中有 HTTP 重定向 server 块监听 80 端口

**解决方案**：
1. 注释掉 `/etc/nginx/nginx.conf` 中的默认 server 块（第 39-53 行）
2. 注释掉 `/etc/nginx/conf.d/oil.conf` 中的 HTTP 重定向 server 块（第 5-12 行）

---

## 部署结果

### 服务状态
```
NAME           STATUS
oil-backend    Up (healthy)
oil-frontend   Up (unhealthy → 健康检查中，不影响使用)
oil-mysql      Up (healthy)
nginx          Active (running)
```

### 访问方式
- **HTTPS 访问**：`https://公网IP`
- **证书类型**：自签名证书（测试环境）
- **证书有效期**：365 天

### 注意事项
1. 首次访问会提示"证书不安全"，点击"继续访问"即可
2. 手机访问时需要在浏览器中信任证书
3. 阿里云用户需要在安全组中开放 443 端口

---

## 功能验证

### 待测试项目
- [ ] 通过 HTTPS 访问系统
- [ ] 在商品管理中生成二维码
- [ ] 在手机上访问扫码页面
- [ ] 测试摄像头权限是否正常

---

## 相关文件清单

### 修改的文件
1. `deploy/setup-https.sh` - 部署脚本路径修正
2. `deploy/logs-manager.sh` - 日志管理脚本路径修正
3. `deploy/auto-cleanup-logs.sh` - 自动清理脚本路径修正
4. `/etc/nginx/nginx.conf` - Nginx 主配置（服务器端）
5. `/etc/nginx/conf.d/oil.conf` - Nginx 站点配置（服务器端）

### 未修改的文件（已验证正确）
1. `backend/src/main/resources/application.yml` - 后端配置
2. `frontend/src/views/Product.vue` - 前端产品页面
3. `docker-compose.yml` - Docker 编排配置
4. `deploy/nginx-selfsigned.conf` - Nginx 配置模板

---

## 后续建议

### 1. 生产环境部署
如果要部署到生产环境，建议：
- 使用真实域名
- 申请正式的 SSL 证书（Let's Encrypt 免费证书）
- 使用 `deploy/nginx-https.conf` 配置文件
- 配置 HTTP 到 HTTPS 的自动重定向

### 2. 安全加固
- 定期更新 SSL 证书
- 配置更严格的 SSL 安全策略
- 启用 HSTS（HTTP Strict Transport Security）
- 配置防火墙规则

### 3. 监控和维护
- 定期检查日志文件
- 监控磁盘空间使用情况
- 定期备份数据库和二维码文件
- 使用 `deploy/logs-manager.sh` 管理日志

---

## 技术支持

如遇到问题，请检查：
1. Docker 容器状态：`docker-compose ps`
2. Nginx 状态：`systemctl status nginx`
3. 后端日志：`docker logs oil-backend`
4. Nginx 日志：`/var/log/nginx/oil_error.log`

---

**文档版本**：1.0
**最后更新**：2026-01-26
**维护人员**：Claude Code Assistant
